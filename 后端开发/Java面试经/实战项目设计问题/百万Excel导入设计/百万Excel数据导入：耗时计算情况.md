> [!IMPORTANT]
>
> 背景介绍：
>
> 对于4核8G服务器，堆内存分配4G，新生代和老年代的比例分配在：1:2的情况下，同时考虑其他应用的正常使用。 我们要导入20个Sheet，每一个Sheet下是60000条数据，总数据大概是1200000条，我们开启10个线程，每一个线程单批次处理量是1000条。
>
> 
>
> 具体分析：
>
> 单个线程，单个批次的耗时，大概是300ms。每一个Sheet大概是60000条数据，按照1000为一个处理单位，大概一个线程需要执行60次。我们10个线程并发处理10个Sheet，有20个Sheet，大概就是跑2轮。所以，总耗时也就是：300ms * 60 * 2 = 36s。
>
> 同时，我们需要考虑：线程切换、数据IO瓶颈以及其他的资源损耗问题，大概也就是：1分钟～2分钟的时间。

要计算整个数据导入的总体耗时，首先需要考虑多个因素，包括：

1. **单批次处理的时间**：每个线程处理1000条数据的时间，包括从Excel中读取数据和插入到数据库中的时间。
2. **并发**线程数：同时运行的线程数对性能有直接影响，尤其是多线程处理时的瓶颈，如CPU、I/O、数据库连接池等。
3. **总批次数**：一共需要处理的批次数量。
4. **线程池**并发处理的效率：线程数不能无限增加，线程上下文切换、数据库连接、CPU核数等都会影响并发处理的效率。
5. **其他系统资源的使用**：服务器的内存、CPU、I/O等资源需要分配给其他应用，因此不能让批处理任务独占所有资源。

### 1. **服务器资源配置**

- **CPU**：4核
- **内存**：8GB，总堆内存为4GB（JVM）。
  - 新生代与老年代的比例为1:2，意味着新生代分配大约1.33GB，老年代分配2.67GB。
  - 服务器上有其他应用需要运行，假设应用使用大约2GB左右的内存。

### 2. **数据量与批次划分**

- **总数据量**：120万行。
- **每批次处理量**：每个线程一次处理1000条数据。
- **线程数**：10个并发线程。
- **批次总数**：总行数 ＝ 1,200,000每批次处理1000条数据，意味着每个Sheet大约有60批次需要处理。

### 3. **单批次处理时间估算**

单批次处理的时间可以分为两个部分：

- **读取时间**：从Excel文件中读取1000条数据。
- **数据库插入时间**：批量插入1000条数据到数据库。

#### 读取时间估算：

- 假设每批次读取1000条数据大约耗时**100ms**，因为EasyExcel是流式读取方式，能够高效读取大数据量的Excel。
- 实际读取时间与I/O性能、文件大小等因素相关。假设每批次读取的时间在**100ms~200ms**左右。

#### 插入时间估算：

- 每批次1000条数据插入数据库，假设一次批量插入耗时大约为**200ms**。
- 插入时间会受到数据库负载、表结构（是否有索引）、网络延迟等影响。批量插入的效率比逐条插入要高。

因此，单批次读取+插入大约耗时：

```Plain
单批次处理时间 ≈ 读取时间 + 插入时间 ≈ 100ms + 200ms = 300ms
```

### 4. **总体批次数**

- 每个Sheet有6万条数据，单个Sheet处理需要`60000 / 1000 = 60`个批次。

- 20个Sheet意味着需要处理的批次总数为：

  - ```Plain
    总批次数 = 20 * 60 = 1200 批次
    ```

### 5. **并发线程处理效率**

我们开启10个并发线程，每个线程独立处理一个Sheet的数据，实际处理批次的时间会受到多线程竞争的影响。

#### 理论上：

- 如果每个线程处理1000条数据的时间是**300ms**，那么每个线程处理60批次大约需要：

  - ```Plain
    单线程处理时间 = 60 * 300ms = 18000ms = 18秒
    ```

- 因为我们有10个线程并发处理，并且每个线程相对独立，处理不同的Sheet，因此每个Sheet的处理时间为：

  - ```Plain
    并发处理总时间 ≈ 单线程处理时间 ≈ 18秒
    ```

#### 实际情况：

1. **CPU**核数限制：我们有4个CPU核，但开启了10个线程，因此可能会有一些线程等待CPU资源，导致实际耗时比理论时间稍长。线程上下文切换和资源争用可能会影响并发处理的效率。
2. **数据库瓶颈**：批量插入操作对数据库造成的压力也会影响处理时间。如果数据库连接池、I/O等资源不足，插入操作可能会发生延迟。

为考虑实际的资源竞争和I/O瓶颈，我们可以假设并发线程处理效率的衰减因子为**1.5倍**，即实际处理时间可能比理论值长50%。

### 6. **总体耗时估算**

因此，考虑到并发效率、CPU核数限制、数据库瓶颈等，实际总体耗时为：

```Plain
总体耗时 ≈ 理论耗时 * 衰减因子 = 18秒 * 1.5 = 27秒
```

### 7. **总结**

在一台4核8GB内存的服务器上，堆内存4GB，开启10个线程并发处理120万条数据，预计总体导入时间为**27秒**左右。此计算是基于每批次处理1000条数据、每批次大约300ms，以及CPU和I/O的竞争带来的性能衰减。

当然，这只是理论估算，实际耗时可能受网络、磁盘I/O、数据库负载等因素影响。